# 设计说明书

## 1. 项目概述

- **名称**：归物+（GoodsManager）
- **定位**：针对租房青年、摄影/旅行爱好者的个人物品全生命周期管理工具，参考「归物」App 的分层定位思路，强调“登记—定位—借用—洞察—提醒”闭环。
- **目标痛点**：物品多且流转频繁，难以记住位置、价值与借用状态；缺少针对纸质标签/二维码的轻量工具；需要跨场景的整理灵感。

## 2. 需求分析

| 模块 | 核心场景 | 约束 |
| --- | --- | --- |
| 资产总览 | 快速查看物品数、重点件、资产估值，获取整理灵感 | 主面板需在 3 秒内加载本地数据，网络失败有兜底提示 |
| 物品档案 | 新增/编辑物品（分类、位置、标签、价值、保修、备注），支持搜索 | 至少 3 个 Activity；Room 持久化；支持二维码生成 |
| 借用管理 | 记录借出人、联系方式、到期时间；查看列表 | WorkManager 每日检查即将到期并触发通知；可标记归还 |
| 数据洞察 | 分类分布、重点物品、资产估值 | 使用 MPAndroidChart 展示图表 |
| 偏好设置 | 暗色主题、借用提醒开关、账号退出 | 支持 Material Design 3、暗色主题 |
| 网络能力 | 获取整理灵感 + LeanCloud 云同步 | Retrofit 请求 `https://api.adviceslip.com/advice`；LeanCloud RESTFul 接口，要求断网操作可缓存、恢复后自动同步 |

## 3. 技术方案

- **架构**：MVVM（ViewModel + LiveData）+ Repository + SessionManager + SyncManager。`AppContainer` 提供依赖注入。
- **数据层**：
  - `Room`：`ItemEntity`/`BorrowRecordEntity` 增加 `ownerId`、`remoteId`、`pendingSync`、`syncAction` 等字段，支撑本地缓存与增量同步；`GoodsDatabase` fallbackToDestructive 便于 schema 演进。
  - `UserPreferencesRepository` & `SessionManager`：SharedPreferences 保存偏好与登录态。
- **网络层**：
  - Retrofit + OkHttp Logging：`TipService` 拉取整理灵感。
  - LeanCloud Storage SDK：`AuthRepository` 负责登录/注册/注销；`LeanSyncManager` 负责 `Item`、`BorrowRecord` 的云端同步。
- **同步机制**：
  - 所有本地写操作先落盘 Room，并标记 `pendingSync` + `syncAction`。
  - `LeanSyncManager`（主动触发 + `LeanSyncWorker` 周期任务）按“推-拉”顺序处理：先推送本地待同步，再拉取云端增量，使用 `updatedAt` / `syncedAt` 做 Last-Write-Wins。
  - `BorrowRecordEntity` 额外维护 `itemRemoteId`，解决跨设备借用记录与物品的关联问题。
- **提醒**：`BorrowReminderWorker` + `NotificationHelper`，基于当前登录用户的借用记录发提醒。
- **UI 层**：ViewBinding + Material3；`AuthActivity`/`LauncherActivity` 管理登录流程；`SettingsActivity` 提供退出登录；RecyclerView、MPAndroidChart、ZXing、Glide 保证可视化与多媒体体验。

## 4. 功能实现

1. **主面板** (`MainActivity`)
   - LiveData 订阅统计、最近入库、网络灵感。
   - 卡片式入口跳转物品列表、借用、统计、设置，Fab 新增物品。
2. **物品档案**
   - `ItemListActivity` 搜索与列表；`ItemEditActivity` 提供预置分类下拉、图片上传（相册/默认图标）、日期选择、重点标记、QR 数据串写入；`ItemDetailActivity` 展示详情、二维码、分享文本。
3. **借用管理**
   - Detail 页面可添加借用记录；`BorrowManageActivity` 全局列表、标记归还。
4. **统计洞察**
   - `StatisticsActivity` 订阅 `StatisticsViewModel` 数据，生成饼图。
5. **偏好设置 & 账户**
   - `SettingsActivity` 绑定暗色/提醒开关，并提供“退出登录”按钮；退出后清空本地缓存并回到 `LauncherActivity`。
6. **账号与同步**
   - `LauncherActivity` 判断登录态，路由到 `AuthActivity` 或业务主页。
   - 登录成功后自动触发一次 `LeanSyncManager`，离线操作由 `pendingSync` 队列兜底，联网后 WorkManager 自动推送。

## 5. 创新亮点

- 结合「归物」理念的“位置+标签+二维码”思路，并加入价值统计与借用提醒形成闭环。
- 基于 LeanCloud 的“用户体系 + 数据云同步 + Session 持久化”，满足“本地优先→自动同步→多终端一致”的工程化要求。
- Room 层内置 `ownerId/remoteId/syncAction` 与 `pendingSync` 队列，搭配 WorkManager+LeanSyncWorker 完成离线缓存与增量同步。
- 将网络灵感、资产洞察、借用提醒整合，强调实用性与差异化。
- 采用 WorkManager + Notification 的软实时提醒，保证低功耗。

## 6. 测试与运行

- **环境**：Android Studio Hedgehog、JDK 21、Gradle 8.6.1、compile/target SDK 35、min SDK 24。
- **测试步骤**：
  1. 运行 `./gradlew assembleDebug`；
  2. 注册/登录 LeanCloud 账号，验证登录态持久化；
  3. 断网状态下新增/编辑/删除物品与借用记录，重连后确认自动同步与多端一致性；
  4. 真机添加 3 类以上物品，验证搜索、二维码、借用流程；
  5. 模拟网络断开查看灵感卡片兜底提示；
  6. 通过 `adb shell cmd jobscheduler run -f <JOB_ID>` 验证借用提醒与 LeanSyncWorker；
  7. 切换暗色主题、借用提醒、退出登录流程，确认偏好与账号状态均持久化。

## 7. 心得

通过本项目完成了一个围绕真实场景的中型应用，特别是在多模块协同（Room + Retrofit + WorkManager + Material3）方面进行了系统实践，确保满足大作业的创新性、实用性与工程化要求。

